---
title: "RCrk Water by aspect: brainstorm"
output:
  html_document:
    code_folding: show
---

```{r echo=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(knitr)
library(DT)
library(gridExtra)
library(grid)
library(reshape2)

```


## Skip forward to test moisture effects on SOC in MIMICS

### Sensor data is not straightforward in Johnston Draw. How far should we pursue it?

* Perhaps we skip the field data for now...

* Alternate approach, we build the data based on an "expected" relationship between soil moisture, aspect and elevation and then push it through MIMICS to observe effects on SOC predictions.


### Expected water:aspect relationship:

* ~50% more precip on North facing slopes relative to south faces

* Difference primarily comes from snow, which serves to elongate the growing season as things warm up in the spring. Thus, effect on NPP and soil activity may not be linear, e.g. effect from more water may be greater than 1.5x. Keep this in mind for MIMICS later.

* Expect the aspect effect on moisture to be attenuated by elevation, both at the low and high end. e.g. Low elevation the effect is less because of lower snow accumulation. Mid-elevations see greatest effect due to water stress and large difference in snow accumulation between opposing slopes. High elevations get more snow everywhere, regardless of aspect. Aspect effect is present, but less important to growing season than in mid-elevations.

### Current data available: Mean annual precipitation vs. elevation

The very general relationship between mean annual precip and elevation across all of Reynolds Creek gives us a place to start.
```{r}
#RCrk: precip by elevation

#get RC data points
RC_pts <- read.csv("C:/GitHub/MIMICS-RCrk/MIMICS-DP/Site_data/RC_forMIMICS_all-rstr_110620.csv", as.is=T)

# test correlation and model fit
r2_test <- cor.test(RC_pts$Kormos_MAP, RC_pts$ELEVATION)
r_val <- round(as.numeric(unlist(r2_test ['estimate'])),3)

map_mdl <- lm(RC_pts$Kormos_MAP~RC_pts$ELEVATION)
mdl_smry <- summary(map_mdl)
intcep <- round(mdl_smry$coefficients[1, 1],2)
rel <- round(mdl_smry$coefficients[2, 1],2)

#plots
MAP_elev_L1 <- ggplot(RC_pts %>% na.omit(), aes(y=Kormos_MAP, x=ELEVATION, color=L1)) + geom_point() +
  geom_abline(intercept = intcep, slope = rel, linetype = "dashed") +
  annotate("text", label = "MAP = 0.72 * ELEV - 641", x = 1600, y = 850, size = 4, colour = "dark blue") +
  annotate("text", label = "r^2 = 0.9", x = 1600, y = 780, size = 4, colour = "dark blue")
  
  
MAP_elev_AC <- ggplot(RC_pts %>% na.omit(), aes(y=Kormos_MAP, x=ELEVATION, color=ASPECT_CLA)) + geom_point() +
  geom_abline(intercept = intcep, slope = rel, linetype = "dashed")

grid.arrange(MAP_elev_L1, MAP_elev_AC, ncol=1)


```

##### Remember, **Kormos MAP is not correct** at small to intermediate catchment scales. It is heavily driven by elevation (r2 > 0.89) and does not reflect aspect effects on snow inputs. 

(?) East vs. West half of RC watershed differences in precipitation. Is that real? Due to storm drop? ...perhaps also a factor to consider when predicting MAP?


## Predicting water inputs at RCrk based on elevation and aspect

Using the broad scale relationship between MAP and Elevation at RCrk, we start with:

```{r}
est_df <- data.frame(ELEV=seq(1000,2200, 10))
est_df$MAP <- (est_df$ELEV*0.72)-641

ggplot(est_df, aes(x=ELEV, y=MAP)) + geom_point(alpha=0.5)

```

#### Next, we need to define a multiplier to adjust for aspect effects on water inputs to soil.

1. A simple factor of 1.5x would be incorrect, as discussed above. Better approach is to weight the aspect effect by elevation, beginning at an elevational threshold where snow retention into thew growing season becomes sensitive to slope aspect. 

2. A more complex multiplier could reduce the effect at high elevations, where differences in snow pack between opposing aspects may be less pronounced due to vegetative cover. 

3. We can also weight the aspect effect by aspect class, where east and west facing slopes are affected, but to a less extent. 

```{r}
#create dataframe with rising and falling effect multiplier

mult_df <- data.frame(range=seq(0,1200,1))
mult_df$rising_sig <- 1/(1+(exp(-(mult_df$range-600)/40)))
mult_df$falling_sig <- 0.5/(1+(exp(-(mult_df$range-950)/200)))
mult_df$complex <- mult_df$rising_sig-(mult_df$falling_sig)+1

# plot(mult_df$range+1000, mult_df$rising_sig)
# plot(mult_df$range+1000, mult_df$falling_sig)
# plot(mult_df$range+1000, (mult_df$rising_sig-(mult_df$falling_sig))+1)

ggplot(mult_df, aes(x=range+1000, y=(rising_sig/2)+1)) + geom_point() +
  xlab("Elevation") +
  ylab("Aspect multiplier") + 
  ggtitle("Simple sigmoid threshold multiplier")

ggplot(mult_df, aes(x=range+1000, y=complex)) + geom_point() +
  xlab("Elevation") +
  ylab("Aspect multiplier") +
  ggtitle("Complex multiplier")

```

#### Apply aspect multiplier to MAP predicted by elevation and we get:

```{r}
#Build dataframe and apply simple aspect multiplier
pred_df <- data.frame(Elevation = seq(1000,2200, 1), 
                      South_eMAP = (seq(1000,2200, 1)*0.72)-641)
                 
pred_df$North_eMAP <- pred_df$South_eMAP * ((mult_df$rising_sig/2)+1)

#The divide by 3 causes EAST and WEST faces to get 1/3 of the north aspect effect
pred_df$EastWest_eMAP <- pred_df$South_eMAP * (((((mult_df$rising_sig/2)+1)-1)/3)+1)

#plot
melted_pred_df <<- melt(pred_df, id.vars=c("Elevation"))

ggplot(melted_pred_df, aes(x=Elevation, y=value, color=variable)) + geom_point(alpha=0.5) +
  xlab("Elevation (m)") +
  ylab ("Predicted effective mean annual precip (mm)") +
  ggtitle("Simple aspect multiplier effect on water input to soil")

```

- East and West faces set to get 1/3 of the North aspect effect multiplier


### CAN I APPLY THIS TO A RASTER? CONDITIONAL RASTER CALCULATOR?
### If that's complicated, just calc aspect values by hand for MIMICS dataset (ugh)


```{r echo=FALSE}

# Repeat for more complex aspect multiplier
# pred_df$North_eMAP_complex <- pred_df$South_eMAP * ((mult_df$complex/2)+1)
# 
# pred_df$EastWest_eMAP_complex <- pred_df$South_eMAP * (((((mult_df$complex/2)+1)-1)/2)+1)
# 
# #plot
# melted_pred_df_complex <<- melt(pred_df, id.vars=c("Elevation"))
# 
# ggplot(melted_pred_df_complex, aes(x=Elevation, y=value, color=variable)) + geom_point(alpha=0.5) +
#   xlab("Elevation (m)") +
#   ylab ("Predicted effective mean annual precip (mm)") +
#   ggtitle("Simple & complex aspect multiplier effect on water input to soil")



```



